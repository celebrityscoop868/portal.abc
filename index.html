<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0"/>
    
    <!-- SEO Meta Tags -->
    <title>SunPower Employee Portal | Secure Login - Access Your Schedule, Payroll & Benefits</title>
    <meta name="description" content="SunPower Employee Portal - Secure access to your work schedule, payroll information, benefits, onboarding progress, and company resources. Login for warehouse and corporate employees.">
    <meta name="keywords" content="SunPower, employee portal, login, schedule, payroll, benefits, onboarding, warehouse jobs, solar energy careers">
    <meta name="author" content="SunPower Corporation">
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://portal.sunpowerc.energy/">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://portal.sunpowerc.energy/">
    <meta property="og:title" content="SunPower Employee Portal | Secure Login">
    <meta property="og:description" content="Access your SunPower employee account. View schedules, payroll, benefits, and complete onboarding tasks.">
    <meta property="og:image" content="https://portal.sunpowerc.energy/assets/og-image.jpg">
    <meta property="og:site_name" content="SunPower Employee Portal">
    <meta property="og:locale" content="en_US">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://portal.sunpowerc.energy/">
    <meta property="twitter:title" content="SunPower Employee Portal | Secure Login">
    <meta property="twitter:description" content="Access your SunPower employee account. View schedules, payroll, benefits, and complete onboarding tasks.">
    <meta property="twitter:image" content="https://portal.sunpowerc.energy/assets/og-image.jpg">
    
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
    <link rel="manifest" href="/assets/site.webmanifest">
    <meta name="theme-color" content="#1565c0">
    <meta name="msapplication-TileColor" content="#1565c0">
    
    <!-- Preconnect for Performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="dns-prefetch" href="https://firebase.googleapis.com">
    
    <!-- Preload Critical Resources -->
    <link rel="preload" href="/assets/app.css" as="style">
    <link rel="preload" href="/assets/ui.js" as="script">
    <link rel="preload" href="/assets/auth.js" as="script">
    
    <!-- Styles -->
    <link rel="stylesheet" href="/assets/app.css">
    
    <!-- Structured Data / JSON-LD -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "SunPower Employee Portal",
        "url": "https://portal.sunpowerc.energy/",
        "description": "Secure employee portal for SunPower Corporation staff. Access schedules, payroll, benefits, and onboarding resources.",
        "publisher": {
            "@type": "Organization",
            "name": "SunPower Corporation",
            "url": "https://www.sunpower.com",
            "logo": {
                "@type": "ImageObject",
                "url": "https://portal.sunpowerc.energy/assets/logo.png"
            }
        }
    }
    </script>
    
    <!-- PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SunPower Portal">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="SunPower Portal">
    
    <!-- Security Headers -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="referrer" content="strict-origin-when-cross-origin">
</head>

<body style="margin:0;background:#e9edf2;font-family:system-ui,-apple-system,Segoe UI,Roboto;">

<!-- Skip to Main Content -->
<a href="#main-content" class="sr-only" style="position:absolute;left:-9999px;">Skip to main content</a>

<!-- BLUE HEADER -->
<header style="
background:linear-gradient(180deg,#0d47a1,#1565c0);
padding:28px 16px 60px 16px;
text-align:center;
color:white;
font-weight:700;
font-size:22px;
letter-spacing:.3px;
" role="banner">
    <h1 style="margin:0;font-size:22px;font-weight:700;">SunPower Employee Portal</h1>
</header>

<!-- MAIN CONTENT -->
<main id="main-content" style="
max-width:420px;
margin:-40px auto 20px;
padding:22px;
background:white;
border-radius:12px;
box-shadow:0 12px 28px rgba(0,0,0,.12);
" role="main">

    <!-- SCREEN: Login Form -->
    <div id="loginScreen">
        <h2 style="margin:0 0 8px;font-size:20px;color:#0d47a1;">Log in to SunPower</h2>

        <p style="margin:0 0 18px;color:#555;font-size:14px;line-height:1.5;">
            Access your schedule, payroll, onboarding and more by securely signing in to your SunPower employee account.
        </p>

        <!-- Google Sign In Button -->
        <button 
            id="btnGoogle" 
            type="button"
            style="
            width:100%;
            padding:14px;
            background:white;
            color:#444;
            border:1px solid #cfd8dc;
            border-radius:6px;
            font-size:16px;
            font-weight:600;
            cursor:pointer;
            margin-bottom:12px;
            display:flex;
            align-items:center;
            justify-content:center;
            gap:10px;
            "
        >
            <svg style="width:18px;height:18px;" viewBox="0 0 24 24">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Sign in with Google
        </button>

        <!-- Email/Password Login -->
        <div style="margin-top:16px;">
            <label for="email" style="font-size:12px;font-weight:700;color:#555;display:block;margin-bottom:6px;">EMAIL</label>
            <input 
                id="email" 
                type="email" 
                placeholder="Enter your email"
                autocomplete="email"
                style="
                width:100%;
                padding:14px;
                margin-bottom:14px;
                border:1px solid #cfd8dc;
                border-radius:6px;
                font-size:15px;
                "
            />

            <label for="pass" style="font-size:12px;font-weight:700;color:#555;display:block;margin-bottom:6px;">PASSWORD</label>
            <input 
                id="pass" 
                type="password" 
                placeholder="Enter your password"
                autocomplete="current-password"
                style="
                width:100%;
                padding:14px;
                margin-bottom:10px;
                border:1px solid #cfd8dc;
                border-radius:6px;
                font-size:15px;
                "
            />

            <!-- Show Password Toggle -->
            <div style="margin:10px 0 18px;">
                <label style="font-size:13px;color:#444;display:flex;align-items:center;gap:8px;cursor:pointer;">
                    <input 
                        type="checkbox" 
                        id="showPass"
                        style="width:16px;height:16px;cursor:pointer;"
                    > 
                    Show password
                </label>
            </div>

            <button 
                id="btnLogin" 
                type="button"
                style="
                width:100%;
                padding:14px;
                background:#1565c0;
                color:white;
                border:none;
                border-radius:6px;
                font-size:16px;
                font-weight:700;
                cursor:pointer;
                "
            >
                Log in
            </button>
        </div>

        <!-- Forgot Password -->
        <div style="text-align:center;margin-top:14px;">
            <button 
                id="btnReset" 
                type="button"
                style="
                background:none;
                border:none;
                color:#1565c0;
                font-size:14px;
                cursor:pointer;
                text-decoration:underline;
                padding:8px;
                "
            >
                Forgot your password?
            </button>
        </div>
    </div>

    <!-- SCREEN: Verification (Employee ID Gate) -->
    <div id="verifyScreen" style="display:none;">
        <h2 style="margin:0 0 8px;font-size:20px;color:#0d47a1;">Verify Your Account</h2>
        <p style="margin:0 0 18px;color:#555;font-size:14px;line-height:1.5;">
            Welcome! Please enter your Employee ID to complete your account setup. This ID was provided to you by HR.
        </p>

        <div id="verifyInfo" style="background:#dbeafe;border-radius:8px;padding:12px;margin-bottom:16px;display:none;">
            <div style="font-size:13px;color:#1e40af;">
                <strong>Email:</strong> <span id="verifyEmail"></span>
            </div>
        </div>

        <label style="font-size:12px;font-weight:700;color:#555;display:block;margin-bottom:6px;">EMPLOYEE ID</label>
        <input 
            id="verifyEmpId" 
            type="text" 
            placeholder="SP001"
            style="text-transform:uppercase;width:100%;padding:14px;margin-bottom:14px;border:1px solid #cfd8dc;border-radius:6px;font-size:15px;"
        />

        <button 
            id="btnVerify" 
            type="button"
            style="
            width:100%;
            padding:14px;
            background:#1565c0;
            color:white;
            border:none;
            border-radius:6px;
            font-size:16px;
            font-weight:700;
            cursor:pointer;
            "
        >
            Verify & Continue
        </button>

        <div style="text-align:center;margin-top:16px;">
            <button 
                id="btnBackToLogin" 
                type="button"
                style="
                background:none;
                border:none;
                color:#1565c0;
                font-size:14px;
                cursor:pointer;
                text-decoration:underline;
                "
            >
                Back to Login
            </button>
        </div>
    </div>

    <!-- SCREEN: Not Registered (Email not in system) -->
    <div id="notRegisteredScreen" style="display:none;">
        <h2 style="margin:0 0 8px;font-size:20px;color:#c62828;">Account Not Found</h2>
        <p style="margin:0 0 18px;color:#555;font-size:14px;line-height:1.5;">
            Your email <strong id="notRegEmail"></strong> is not registered in our system.
        </p>
        
        <div style="padding:16px;background:#fff3cd;border-radius:8px;margin-bottom:18px;">
            <strong>What to do:</strong><br>
            Contact your supervisor or HR to get your Employee ID assigned. Once assigned, you can sign in with Google and enter your ID.
        </div>
        
        <button 
            id="btnTryAgainNotReg" 
            type="button"
            style="
            width:100%;
            padding:14px;
            background:#1565c0;
            color:white;
            border:none;
            border-radius:6px;
            font-size:16px;
            font-weight:700;
            cursor:pointer;
            "
        >
            Try Again
        </button>
    </div>

    <!-- Help Text -->
    <div style="margin-top:24px;padding:16px;background:#f3f4f6;border-radius:8px;text-align:center;">
        <p style="margin:0;font-size:13px;color:#6b7280;">
            <strong>New employee?</strong><br>
            Your account will be created by HR. Contact your supervisor for your Employee ID.
        </p>
    </div>

    <!-- Error Message -->
    <div 
        id="msg" 
        style="color:#c62828;margin-top:12px;font-size:14px;text-align:center;min-height:20px;"
        role="alert"
        aria-live="assertive"
    ></div>

</main>

<!-- Footer -->
<footer style="text-align:center;color:#777;font-size:13px;margin:20px 0;padding:0 16px;" role="contentinfo">
    <p style="margin:0 0 8px;">
        © <span id="year"></span> SunPower Corporation. All rights reserved.
    </p>
    <p style="margin:0;font-size:12px;color:#999;">
        <a href="#privacy" style="color:#999;text-decoration:underline;">Privacy Policy</a> | 
        <a href="#terms" style="color:#999;text-decoration:underline;">Terms of Use</a> | 
        <a href="#help" style="color:#999;text-decoration:underline;">Help & Support</a>
    </p>
</footer>

<!-- Application Scripts -->
<script type="module">
    import { uiSetText, uiToast } from "/assets/ui.js";
    import {
        authReady,
        signInEmail,
        signInGoogle,
        verifyEmployeeId,
        isAdminUser,
        signOutNow
    } from "/assets/auth.js";

    const yearEl = document.getElementById("year");
    const msg = document.getElementById("msg");
    const loginScreen = document.getElementById("loginScreen");
    const verifyScreen = document.getElementById("verifyScreen");
    const notRegisteredScreen = document.getElementById("notRegisteredScreen");

    yearEl.textContent = new Date().getFullYear();

    function showScreen(screen) {
        loginScreen.style.display = 'none';
        verifyScreen.style.display = 'none';
        notRegisteredScreen.style.display = 'none';
        if (screen) screen.style.display = 'block';
        uiSetText(msg, "");
    }

    function showErr(e) { 
        uiSetText(msg, e?.message || String(e)); 
    }
    
    function setBusy(b) {
        const buttons = document.querySelectorAll('button');
        buttons.forEach(btn => btn.disabled = b);
    }

    // Show/hide password
    document.getElementById("showPass").onchange = function() {
        const pass = document.getElementById("pass");
        pass.type = this.checked ? "text" : "password";
    };

    // Google Sign In
    document.getElementById("btnGoogle").onclick = async () => {
        uiSetText(msg, "");
        setBusy(true);
        try {
            const result = await signInGoogle();
            
            // Admin user → directo a admin
            if (result.isAdmin) {
                window.location.href = '/admin.html';
                return;
            }
            
            // Usuario verificado → directo a employee
            if (result.verified) {
                window.location.href = '/employee.html#progress';
                return;
            }
            
            // Necesita verificación → mostrar gate
            if (result.needsVerification) {
                showScreen(verifyScreen);
                window.pendingUser = result.user;
                
                // Mostrar email en el gate
                document.getElementById("verifyEmail").textContent = result.email;
                document.getElementById("verifyInfo").style.display = 'block';
                
                // Si tiene employeeId sugerido (está en allowedEmployees), mostrarlo como hint
                if (result.employeeId) {
                    document.getElementById("verifyEmpId").placeholder = result.employeeId;
                }
                
                setBusy(false);
                return;
            }
            
            // No debería llegar aquí, pero por si acaso
            showErr("Unexpected error. Please try again.");
            setBusy(false);
            
        } catch (e) {
            showErr(e);
            setBusy(false);
        }
    };

    // Email Login (solo admin)
    document.getElementById("btnLogin").onclick = async () => {
        uiSetText(msg, "");
        setBusy(true);
        try {
            const email = document.getElementById("email").value.trim();
            const pass = document.getElementById("pass").value.trim();
            if (!email || !pass) throw new Error("Enter email and password.");
            
            const result = await signInEmail(email, pass);
            
            // Verificar si es admin
            const isAdmin = await isAdminUser(result.user);
            if (isAdmin) {
                window.location.href = '/admin.html';
            } else {
                // No debería pasar, pero por si acaso
                throw new Error("Only admins can use email login");
            }
            
        } catch (e) {
            showErr(e);
            setBusy(false);
        }
    };

    // Verify Employee ID (desde el gate)
    document.getElementById("btnVerify").onclick = async () => {
        const empId = document.getElementById("verifyEmpId").value.trim().toUpperCase();
        
        if (!empId) {
            showErr("Please enter your Employee ID");
            return;
        }
        
        setBusy(true);
        try {
            const result = await verifyEmployeeId(window.pendingUser, empId);
            
            if (result.success) {
                uiToast("Account verified! Welcome to SunPower.");
                window.location.href = '/employee.html#progress';
            }
        } catch (e) {
            showErr(e);
            setBusy(false);
        }
    };

    // Back buttons
    document.getElementById("btnBackToLogin").onclick = async () => {
        await signOutNow();
        showScreen(loginScreen);
        setBusy(false);
    };
    
    document.getElementById("btnTryAgainNotReg").onclick = async () => {
        await signOutNow();
        showScreen(loginScreen);
        setBusy(false);
    };

    // Password reset
    document.getElementById("btnReset").onclick = async () => {
        uiSetText(msg, "");
        const email = prompt("Enter your email for password reset:");
        if (!email) return;
        
        setBusy(true);
        try {
            const { sendPasswordResetEmail } = await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js");
            const { auth } = await import("/assets/firebase.js");
            await sendPasswordResetEmail(auth, email);
            uiToast("Password reset email sent!");
        } catch (e) {
            showErr(e);
        }
        setBusy(false);
    };

    // Enter key support
    document.getElementById("pass").addEventListener("keydown", e => {
        if (e.key === "Enter") {
            e.preventDefault();
            document.getElementById("btnLogin").click();
        }
    });
    
    document.getElementById("email").addEventListener("keydown", e => {
        if (e.key === "Enter") {
            e.preventDefault();
            document.getElementById("pass").focus();
        }
    });

    document.getElementById("verifyEmpId").addEventListener("keydown", e => {
        if (e.key === "Enter") {
            e.preventDefault();
            document.getElementById("btnVerify").click();
        }
    });

    // Focus email on load
    document.getElementById("email")?.focus();
</script>

</body>
</html>
